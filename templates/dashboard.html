{% extends "base.html" %}
{% block title %}Decision Dashboards â€” MIGIS{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  .kpi-grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
  .badge{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(122,162,255,.25);background:rgba(255,255,255,.03);color:#e8ecf7}
  .status-critical{border-left:4px solid #e74c3c}
  .status-warning{border-left:4px solid #f39c12}
  .status-good{border-left:4px solid #27ae60}
  .metric{font-size:28px;font-weight:700;letter-spacing:.3px}
  .list{display:grid;gap:10px;margin-top:10px}
  .muted{color:#a9b2c7}
  canvas{background:transparent;border-radius:12px;border:1px solid rgba(122,162,255,.14);padding:10px}
</style>
{% endblock %}

{% block content %}
<a class="back" href="/">â† Back to main</a>

<section class="hero">
  <h1>MIGIS District Command Center</h1>
  <p class="subtitle">Live Health & Infrastructure Monitoring</p>
  <div class="panel">
    <span class="badge">Auto-refresh: 60s</span>
  </div>
</section>

<section style="padding-top:16px">
  <div class="kpi-grid">
    <!-- Health Risks -->
    <article class="card status-critical">
      <h3 style="margin:0 0 6px 0;font-size:16px;">ğŸš¨ Critical Health Risks</h3>
      <p class="muted" style="margin:0 0 10px 0;">Blocks with elevated epidemic triggers</p>
      <div id="health-risks" class="list"><span class="muted">Loading health dataâ€¦</span></div>
    </article>

    <!-- Infrastructure -->
    <article class="card status-warning">
      <h3 style="margin:0 0 6px 0;font-size:16px;">ğŸ—ï¸ Infrastructure Health</h3>
      <p class="muted" style="margin:0 0 10px 0;">Asset condition and risk outlook</p>
      <div id="infrastructure" class="list"><span class="muted">Loading infrastructure dataâ€¦</span></div>
    </article>

    <!-- AI Analysis -->
    <article class="card status-good">
      <h3 style="margin:0 0 6px 0;font-size:16px;">ğŸ¤– AI Analysis & Recommendations</h3>
      <p class="muted" style="margin:0 0 10px 0;">Priority actions generated by the AI engine</p>
      <div id="ai-analysis" style="white-space:pre-line" class="muted">Loading AI analysisâ€¦</div>
    </article>
  </div>
</section>

<section style="padding-top:16px">
  <div class="card">
    <h3 style="margin:0 0 12px 0;font-size:16px;">ğŸ“ˆ District Trend (Demo)</h3>
    <canvas id="trendChart" height="120"></canvas>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
let trendChart;

function renderTrendChart() {
  const ctx = document.getElementById('trendChart').getContext('2d');
  if (trendChart) trendChart.destroy();
  trendChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: ['W1','W2','W3','W4','W5','W6'],
      datasets: [
        { label: 'Health Risk Index', data: [42, 48, 51, 60, 57, 62], borderWidth: 2, tension: .25, fill: false },
        { label: 'Infra Risk Index', data: [30, 34, 33, 40, 39, 44], borderWidth: 2, tension: .25, fill: false }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { labels: { color: '#e8ecf7' } },
        tooltip: { mode: 'index', intersect: false }
      },
      scales: {
        x: { ticks: { color: '#a9b2c7' }, grid: { color: 'rgba(122,162,255,.12)' } },
        y: { ticks: { color: '#a9b2c7' }, grid: { color: 'rgba(122,162,255,.12)' } }
      }
    }
  });
}

async function loadDashboard() {
  try {
    // Health risks
    const healthResponse = await fetch('/api/health-risks');
    const healthData = await healthResponse.json();
    document.getElementById('health-risks').innerHTML =
      (healthData.health_risks || []).map(risk =>
        `<div>ğŸ“ <strong>${risk.block}</strong> â€” ${risk.disease} <span class="muted">(Risk: ${risk.risk_score}%)</span></div>`
      ).join('') || '<span class="muted">No active alerts.</span>';

    // Infrastructure
    const infraResponse = await fetch('/api/infrastructure');
    const infraData = await infraResponse.json();
    document.getElementById('infrastructure').innerHTML =
      (infraData.infrastructure || []).map(asset =>
        `<div>ğŸ—ï¸ <strong>${asset.asset}</strong> â€” ${asset.health_score}% health <span class="muted">(${asset.risk})</span></div>`
      ).join('') || '<span class="muted">No issues reported.</span>';

    // AI analysis
    const aiResponse = await fetch('/api/ai-analysis');
    const aiData = await aiResponse.json();
    document.getElementById('ai-analysis').textContent = aiData.analysis || 'No recommendations at this time.';
  } catch (err) {
    console.error(err);
    document.getElementById('ai-analysis').textContent =
      'System analysis: Focus on coastal health risks and bridge safety.';
  }
}

// initial render
renderTrendChart();
loadDashboard();
// auto-refresh
setInterval(loadDashboard, 60000);
</script>
{% endblock %}
